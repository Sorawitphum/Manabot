import discord
from discord import app_commands
from discord.ext import commands
import datetime
import logging
import config
from typing import Optional, List
import asyncio
import os

class Announce(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.logger = logging.getLogger(__name__)
        self.logger.info("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®")

    def get_icon_path(self, icon_name: str) -> Optional[str]:
        """‡∏´‡∏≤ path ‡∏Ç‡∏≠‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå assets"""
        assets_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'assets')
        icon_path = os.path.join(assets_dir, icon_name)
        if os.path.exists(icon_path):
            return icon_path
        return None

    @app_commands.command(
        name="announce",
        description="‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"
    )
    @app_commands.describe(
        channel="‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
        message="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
        color="‡∏™‡∏µ‡∏Ç‡∏≠‡∏á embed (hex code ‡πÄ‡∏ä‡πà‡∏ô #FF0000)",
        template="‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
        schedule="‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡πÄ‡∏ä‡πà‡∏ô 2024-03-08 23:00)"
    )
    @app_commands.choices(template=[
        app_commands.Choice(name=template_name, value=template_name)
        for template_name in config.ANNOUNCEMENT_TEMPLATES.keys()
    ])
    async def announce(
        self,
        interaction: discord.Interaction,
        channel: discord.TextChannel,
        message: str,
        template: str = "normal",
        color: Optional[str] = None,
        schedule: Optional[str] = None
    ):
        """‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"""
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        user_roles = [role.name for role in interaction.user.roles]
        allowed_roles = [role for role in config.ANNOUNCEMENT_ROLES if role in user_roles]
        
        if not allowed_roles:
            await interaction.response.send_message(
                f"‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó {', '.join(config.ANNOUNCEMENT_ROLES)} ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
                ephemeral=True
            )
            return

        try:
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á embed
            template_data = config.ANNOUNCEMENT_TEMPLATES[template]
            
            # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ
            if color:
                try:
                    embed_color = int(color.replace("#", ""), 16)
                except ValueError:
                    await interaction.response.send_message("‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏µ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö #RRGGBB", ephemeral=True)
                    return
            else:
                try:
                    embed_color = int(template_data["color"].replace("#", ""), 16)
                except (ValueError, AttributeError):
                    embed_color = 0x3498db  # ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

            embed = discord.Embed(
                title=template_data["title"],
                description=message,
                color=embed_color,
                timestamp=datetime.datetime.now()
            )
            embed.set_footer(text=f"‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÇ‡∏î‡∏¢ {interaction.user.display_name}", icon_url=interaction.user.display_avatar.url)
            
            # ‡πÄ‡∏û‡∏¥‡πà‡∏° thumbnail ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå assets
            icon_path = self.get_icon_path(template_data["icon"])
            
            # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤
            if schedule:
                try:
                    schedule_time = datetime.datetime.strptime(schedule, "%Y-%m-%d %H:%M")
                    if schedule_time < datetime.datetime.now():
                        await interaction.response.send_message("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ", ephemeral=True)
                        return
                    
                    # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                    await interaction.response.send_message(
                        f"‚úÖ ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á {channel.mention} ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤ {schedule}",
                        ephemeral=True
                    )
                    
                    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠
                    wait_seconds = (schedule_time - datetime.datetime.now()).total_seconds()
                    
                    # ‡∏£‡∏≠‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                    await asyncio.sleep(wait_seconds)
                    
                    # ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                    if icon_path:
                        file = discord.File(icon_path, filename=template_data["icon"])
                        embed.set_thumbnail(url=f"attachment://{template_data['icon']}")
                        await channel.send(embed=embed, file=file)
                    else:
                        await channel.send(embed=embed)
                        
                except ValueError:
                    await interaction.response.send_message(
                        "‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD HH:MM",
                        ephemeral=True
                    )
                    return
            else:
                # ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                await interaction.response.send_message(
                    f"‚úÖ ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á {channel.mention} ‡πÅ‡∏•‡πâ‡∏ß",
                    ephemeral=True
                )
                
                if icon_path:
                    file = discord.File(icon_path, filename=template_data["icon"])
                    embed.set_thumbnail(url=f"attachment://{template_data['icon']}")
                    await channel.send(embed=embed, file=file)
                else:
                    await channel.send(embed=embed)

            # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            if config.ANNOUNCEMENT_LOG_CHANNEL_ID:
                log_channel = self.bot.get_channel(config.ANNOUNCEMENT_LOG_CHANNEL_ID)
                if log_channel:
                    log_embed = discord.Embed(
                        title="üì¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
                        color=discord.Color.blue(),
                        timestamp=datetime.datetime.now()
                    )
                    log_embed.add_field(name="‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®", value=interaction.user.mention, inline=True)
                    log_embed.add_field(name="‡∏ä‡πà‡∏≠‡∏á", value=channel.mention, inline=True)
                    log_embed.add_field(name="‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö", value=template_data["title"], inline=True)
                    if schedule:
                        log_embed.add_field(name="‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á", value=schedule, inline=True)
                    log_embed.add_field(name="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°", value=message, inline=False)
                    await log_channel.send(embed=log_embed)

        except Exception as e:
            self.logger.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: {e}")
            await interaction.response.send_message("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®", ephemeral=True)

    @app_commands.command(
        name="announcement",
        description="‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®"
    )
    async def announcement_help(self, interaction: discord.Interaction):
        """‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®"""
        embed = discord.Embed(
            title="üì¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
            description="‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
            color=discord.Color.blue()
        )

        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å
        embed.add_field(
            name="üìù ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å",
            value="`/announce` - ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å",
            inline=False
        )

        # ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
        embed.add_field(
            name="‚öôÔ∏è ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå",
            value="""
`channel` - ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
`message` - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
`color` - ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á embed (hex code ‡πÄ‡∏ä‡πà‡∏ô #FF0000)
`template` - ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
`schedule` - ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡πÄ‡∏ä‡πà‡∏ô 2024-03-08 23:00)
            """,
            inline=False
        )

        # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
        templates = "\n".join([
            f"‚Ä¢ {template['title']} - {template_name}"
            for template_name, template in config.ANNOUNCEMENT_TEMPLATES.items()
        ])
        embed.add_field(
            name="üé® ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
            value=templates,
            inline=False
        )

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        embed.add_field(
            name="üìö ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
            value="""
1. `/announce channel:#‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® message:"‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ 23.00 ‡∏ô." template:warning`
2. `/announce channel:#‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ message:"‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà!" template:event color:#FF0000`
3. `/announce channel:#‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® message:"‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤" template:normal schedule:2024-03-08 23:00`
            """,
            inline=False
        )

        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
        embed.add_field(
            name="‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î",
            value=f"‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó {', '.join(config.ANNOUNCEMENT_ROLES)} ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
            inline=False
        )

        await interaction.response.send_message(embed=embed, ephemeral=True)

async def setup(bot):
    await bot.add_cog(Announce(bot))
    logging.info("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå") 